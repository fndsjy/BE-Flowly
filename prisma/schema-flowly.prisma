generator client {
  provider = "prisma-client-js"
  output   = "../dist/generated/flowly"
}

generator clientSrc {
  provider = "prisma-client-js"
  output   = "../src/generated/flowly"
}

datasource db {
  provider = "sqlserver"
  url      = env("FLOWLY_DATABASE_URL")
}

/// Role defines user permissions and access tiers
/// Level: 1 = Super Admin, 2 = Supervisor, 3 = Staff, 4 = Non Staff, 5 = Guest
model Role {
  /// e.g., "ROL251117-0001"
  roleId       String    @id @db.NVarChar(20)
  roleName     String    @db.NVarChar(50)
  roleLevel    Int
  roleDesc     String?   @db.NVarChar(255)
  roleIsActive Boolean   @default(true)
  createdAt    DateTime  @default(now())
  /// references User.userId
  createdBy    String?   @db.NVarChar(20)
  updatedAt    DateTime  @updatedAt
  /// references User.userId
  updatedBy    String?   @db.NVarChar(20)
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  /// references User.userId
  deletedBy    String?   @db.NVarChar(20)
  creator      User?     @relation("RoleCreatedBy", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  deleter      User?     @relation("RoleDeletedBy", fields: [deletedBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  updater      User?     @relation("RoleUpdatedBy", fields: [updatedBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  users        User[]

  @@index([createdBy])
  @@index([updatedBy])
  @@index([deletedBy])
  @@map("roles")
}

/// User represents an authenticated individual in the system
model User {
  /// e.g., "USR251117-0001"
  userId       String    @id @db.NVarChar(20)
  username     String    @unique @db.NVarChar(30)
  /// bcrypt/scrypt hashed
  password     String    @db.NVarChar(100)
  name         String    @db.NVarChar(100)
  badgeNumber  String    @db.NVarChar(20)
  department   String?   @db.NVarChar(50)
  isActive     Boolean   @default(true)
  lastLogin    DateTime?
  createdAt    DateTime  @default(now())
  /// references User.userId
  createdBy    String?   @db.NVarChar(20)
  updatedAt    DateTime  @updatedAt
  /// references User.userId
  updatedBy    String?   @db.NVarChar(20)
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  /// references User.userId
  deletedBy    String?   @db.NVarChar(20)
  /// Role assignment
  roleId       String    @db.NVarChar(20)
  /// Optional auth token (e.g., refresh token)
  token        String?   @db.NVarChar(500)
  createdRoles Role[]    @relation("RoleCreatedBy")
  deletedRoles Role[]    @relation("RoleDeletedBy")
  updatedRoles Role[]    @relation("RoleUpdatedBy")
  creator      User?     @relation("UserCreatedBy", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  createdUsers User[]    @relation("UserCreatedBy")
  deleter      User?     @relation("UserDeletedBy", fields: [deletedBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  deletedUsers User[]    @relation("UserDeletedBy")
  role         Role      @relation(fields: [roleId], references: [roleId])
  updater      User?     @relation("UserUpdatedBy", fields: [updatedBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  updatedUsers User[]    @relation("UserUpdatedBy")

  @@index([username])
  @@index([badgeNumber])
  @@index([roleId])
  @@index([createdBy])
  @@index([updatedBy])
  @@index([deletedBy])
  @@map("users")
}

model Chart {
  /// e.g., "NODE251120-0001"
  chartId    String        @id @db.NVarChar(20)
  pilarId    Int
  sbuId      Int
  sbuSubId   Int
  /// NULL = posisi teratas (presiden)
  parentId   String?       @db.NVarChar(20)
  position   String        @db.NVarChar(100)
  capacity   Int           @default(1)
  /// urutan dalam satu level
  orderIndex Int           @default(0)
  createdAt  DateTime      @default(now())
  createdBy  String?       @db.NVarChar(20)
  updatedAt  DateTime      @updatedAt
  updatedBy  String?       @db.NVarChar(20)
  isDeleted  Boolean       @default(false)
  deletedAt  DateTime?
  deletedBy  String?       @db.NVarChar(20)
  jobDesc    String?       @db.NVarChar(500)
  parent     Chart?        @relation("ParentChild", fields: [parentId], references: [chartId], onDelete: NoAction, onUpdate: NoAction)
  children   Chart[]       @relation("ParentChild")
  members    ChartMember[]

  @@index([parentId])
  @@index([pilarId])
  @@index([sbuId])
  @@index([sbuSubId])
  @@map("chart")
}

model ChartMember {
  memberChartId String    @id @db.NVarChar(20)
  chartId       String    @db.NVarChar(20)
  userId        Int?
  createdAt     DateTime  @default(now())
  createdBy     String?   @db.NVarChar(20)
  updatedAt     DateTime  @updatedAt
  updatedBy     String?   @db.NVarChar(20)
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  deletedBy     String?   @db.NVarChar(20)
  jabatan       String?   @db.NVarChar(50)
  node          Chart     @relation(fields: [chartId], references: [chartId])

  @@index([chartId])
  @@index([userId])
  @@map("chart_member")
}

/// SOP master within Prosedur
model ProcedureSop {
  sopId         String           @id @db.NVarChar(20)
  sbuSubId      Int
  sbuId         Int?
  pilarId       Int?
  sopName       String           @db.NVarChar(150)
  sopNumber     String           @db.NVarChar(50)
  effectiveDate DateTime
  filePath      String           @db.NVarChar(500)
  fileName      String           @db.NVarChar(255)
  fileMime      String?          @db.NVarChar(100)
  fileSize      Int?
  isActive      Boolean          @default(true)
  isDeleted     Boolean          @default(false)
  createdAt     DateTime         @default(now())
  createdBy     String?          @db.NVarChar(20)
  updatedAt     DateTime         @updatedAt
  updatedBy     String?          @db.NVarChar(20)
  deletedAt     DateTime?
  deletedBy     String?          @db.NVarChar(20)
  masterIKs     ProcedureSopIK[]

  @@index([sbuSubId, isActive, isDeleted])
  @@index([sbuId])
  @@index([pilarId])
  @@index([sopNumber])
  @@map("procedure_sop")
}

/// Master IK shared across SOPs
model MasterIK {
  ikId          String           @id @db.NVarChar(20)
  ikName        String           @db.NVarChar(150)
  ikNumber      String           @db.NVarChar(50)
  effectiveDate DateTime
  ikContent     String?          @db.NVarChar(Max)
  isActive      Boolean          @default(true)
  isDeleted     Boolean          @default(false)
  createdAt     DateTime         @default(now())
  createdBy     String?          @db.NVarChar(20)
  updatedAt     DateTime         @updatedAt
  updatedBy     String?          @db.NVarChar(20)
  deletedAt     DateTime?
  deletedBy     String?          @db.NVarChar(20)
  sops          ProcedureSopIK[]

  @@index([ikNumber])
  @@map("master_ik")
}

/// SOP to Master IK join table
model ProcedureSopIK {
  sopIkId   String       @id @db.NVarChar(20)
  sopId     String       @db.NVarChar(20)
  ikId      String       @db.NVarChar(20)
  isActive  Boolean      @default(true)
  isDeleted Boolean      @default(false)
  createdAt DateTime     @default(now())
  createdBy String?      @db.NVarChar(20)
  updatedAt DateTime     @updatedAt
  updatedBy String?      @db.NVarChar(20)
  deletedAt DateTime?
  deletedBy String?      @db.NVarChar(20)
  sop       ProcedureSop @relation(fields: [sopId], references: [sopId], onDelete: NoAction, onUpdate: NoAction)
  masterIK  MasterIK     @relation(fields: [ikId], references: [ikId], onDelete: NoAction, onUpdate: NoAction)

  @@index([sopId, isActive, isDeleted])
  @@index([ikId, isActive, isDeleted])
  @@map("procedure_sop_ik")
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model jabatan {
  jabatanId       String    @id @db.NVarChar(20)
  jabatanName     String    @db.NVarChar(100)
  jabatanLevel    Int
  jabatanDesc     String?   @db.NVarChar(255)
  jabatanIsActive Boolean
  createdAt       DateTime
  createdBy       String?   @db.NVarChar(20)
  updatedAt       DateTime
  updatedBy       String?   @db.NVarChar(20)
  isDeleted       Boolean
  deletedAt       DateTime?
  deletedBy       String?   @db.NVarChar(20)

  @@index([jabatanId])
  @@map("jabatan")
}

/// Access rules for per-user or role permissions
model AccessRole {
  accessId     String    @id @db.NVarChar(20)
  subjectType  String    @db.NVarChar(10)
  subjectId    String    @db.NVarChar(20)
  resourceType String    @db.NVarChar(20)
  masAccessId  String?   @db.NVarChar(20)
  resourceKey  String?   @db.NVarChar(50)
  accessLevel  String    @db.NVarChar(10)
  isActive     Boolean   @default(true)
  isDeleted    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  createdBy    String?   @db.NVarChar(20)
  updatedAt    DateTime  @updatedAt
  updatedBy    String?   @db.NVarChar(20)
  deletedAt    DateTime?
  deletedBy    String?   @db.NVarChar(20)

  @@unique([subjectType, subjectId, resourceType, masAccessId, resourceKey])
  @@index([subjectType, subjectId])
  @@index([resourceType, masAccessId])
  @@map("access_role")
}

/// Resource catalog for menu/module definitions
model MasterAccessRole {
  masAccessId  String    @id @db.NVarChar(20)
  resourceType String    @db.NVarChar(20)
  resourceKey  String    @db.NVarChar(50)
  displayName  String    @db.NVarChar(100)
  route        String?   @db.NVarChar(200)
  parentKey    String?   @db.NVarChar(50)
  orderIndex   Int       @default(0)
  isActive     Boolean   @default(true)
  isDeleted    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  createdBy    String?   @db.NVarChar(20)
  updatedAt    DateTime  @updatedAt
  updatedBy    String?   @db.NVarChar(20)
  deletedAt    DateTime?
  deletedBy    String?   @db.NVarChar(20)

  @@unique([resourceType, resourceKey])
  @@index([parentKey])
  @@map("master_access_role")
}

/// Audit log for tracking CRUD and revision actions
model AuditLog {
  logId     Int      @id @default(autoincrement())
  module    String   @db.NVarChar(50)
  entity    String   @db.NVarChar(50)
  entityId  String   @db.NVarChar(50)
  action    String   @db.NVarChar(20)
  actorId   String?  @db.NVarChar(20)
  actorType String?  @db.NVarChar(20)
  changes   String?  @db.NVarChar(Max)
  snapshot  String?  @db.NVarChar(Max)
  meta      String?  @db.NVarChar(Max)
  createdAt DateTime @default(now())

  @@index([module])
  @@index([entity])
  @@index([entityId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_log")
}
